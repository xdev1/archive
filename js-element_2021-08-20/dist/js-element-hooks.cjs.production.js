"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("js-element/core"),t=new WeakMap,r=Symbol("iteration key");function n(e,t,r){var n=t.get(r);n&&n.forEach(e.add,e)}function o(e){e.delete(this)}var a=[],s=!1;function u(e,t,r,n){if(e.unobserved)return Reflect.apply(t,r,n);if(-1===a.indexOf(e)){!function(e){e.cleaners&&e.cleaners.forEach(o,e),e.cleaners=[]}(e);try{return a.push(e),Reflect.apply(t,r,n)}finally{a.pop()}}}function c(e){var n=a[a.length-1];n&&(f(n,e),function(e,n){var o=n.target,a=n.key;"iterate"===n.type&&(a=r);var s=t.get(o),u=s.get(a);u||(u=new Set,s.set(a,u)),u.has(e)||(u.add(e),e.cleaners.push(u))}(n,e))}function i(e){(function(e){var o=e.target,a=e.key,s=e.type,u=t.get(o),c=new Set;if("clear"===s?u.forEach((function(e,t){n(c,u,t)})):n(c,u,a),"add"===s||"delete"===s||"clear"===s){var i=Array.isArray(o)?"length":r;n(c,u,i)}return c})(e).forEach(l,e)}function l(e){f(e,this),"function"==typeof e.scheduler?e.scheduler(e):"object"==typeof e.scheduler?e.scheduler.add(e):e()}function f(e,t){if(e.debugger&&!s)try{s=!0,e.debugger(t)}finally{s=!1}}function p(){return a.length>0}var y=Symbol("is reaction");var d=new WeakMap,g=new WeakMap,h=Object.prototype.hasOwnProperty;function v(e){var t=g.get(e);return p()&&"object"==typeof e&&null!==e?t||R(e):t||e}function b(e,t){var r=e.next;return e.next=function(){var n=r.call(e),o=n.done,a=n.value;return o||(t?a[1]=v(a[1]):a=v(a)),{done:o,value:a}},e}var m={has:function(e){var t=d.get(this),r=Reflect.getPrototypeOf(this);return c({target:t,key:e,type:"has"}),r.has.apply(t,arguments)},get:function(e){var t=d.get(this),r=Reflect.getPrototypeOf(this);return c({target:t,key:e,type:"get"}),v(r.get.apply(t,arguments))},add:function(e){var t=d.get(this),r=Reflect.getPrototypeOf(this),n=r.has.call(t,e),o=r.add.apply(t,arguments);return n||i({target:t,key:e,value:e,type:"add"}),o},set:function(e,t){var r=d.get(this),n=Reflect.getPrototypeOf(this),o=n.has.call(r,e),a=n.get.call(r,e),s=n.set.apply(r,arguments);return o?t!==a&&i({target:r,key:e,value:t,oldValue:a,type:"set"}):i({target:r,key:e,value:t,type:"add"}),s},delete:function(e){var t=d.get(this),r=Reflect.getPrototypeOf(this),n=r.has.call(t,e),o=r.get?r.get.call(t,e):void 0,a=r.delete.apply(t,arguments);return n&&i({target:t,key:e,oldValue:o,type:"delete"}),a},clear:function(){var e=d.get(this),t=Reflect.getPrototypeOf(this),r=0!==e.size,n=e instanceof Map?new Map(e):new Set(e),o=t.clear.apply(e,arguments);return r&&i({target:e,oldTarget:n,type:"clear"}),o},forEach:function(e){for(var t=[],r=arguments.length-1;r-- >0;)t[r]=arguments[r+1];var n=d.get(this),o=Reflect.getPrototypeOf(this);c({target:n,type:"iterate"});var a,s=function(t){for(var r=[],n=arguments.length-1;n-- >0;)r[n]=arguments[n+1];return e.apply(void 0,[v(t)].concat(r))};return(a=o.forEach).call.apply(a,[n,s].concat(t))},keys:function(){var e=d.get(this),t=Reflect.getPrototypeOf(this);return c({target:e,type:"iterate"}),t.keys.apply(e,arguments)},values:function(){var e=d.get(this),t=Reflect.getPrototypeOf(this);c({target:e,type:"iterate"});var r=t.values.apply(e,arguments);return b(r,!1)},entries:function(){var e=d.get(this),t=Reflect.getPrototypeOf(this);c({target:e,type:"iterate"});var r=t.entries.apply(e,arguments);return b(r,!0)},get size(){var e=d.get(this),t=Reflect.getPrototypeOf(this);return c({target:e,type:"iterate"}),Reflect.get(t,"size",e)}};m[Symbol.iterator]=function(){var e=d.get(this),t=Reflect.getPrototypeOf(this);c({target:e,type:"iterate"});var r=t[Symbol.iterator].apply(e,arguments);return b(r,e instanceof Map)};var x={get:function(e,t,r){return e=h.call(m,t)?m:e,Reflect.get(e,t,r)}},k="object"==typeof window?window:Function("return this")(),w=new Map([[Map,x],[Set,x],[WeakMap,x],[WeakSet,x],[Object,!1],[Array,!1],[Int8Array,!1],[Uint8Array,!1],[Uint8ClampedArray,!1],[Int16Array,!1],[Uint16Array,!1],[Int32Array,!1],[Uint32Array,!1],[Float32Array,!1],[Float64Array,!1]]);function O(e){return w.get(e.constructor)}var S=Object.prototype.hasOwnProperty,j=new Set(Object.getOwnPropertyNames(Symbol).map((function(e){return Symbol[e]})).filter((function(e){return"symbol"==typeof e})));var M={get:function(e,t,r){var n=Reflect.get(e,t,r);if("symbol"==typeof t&&j.has(t))return n;c({target:e,key:t,receiver:r,type:"get"});var o=g.get(n);if(p()&&"object"==typeof n&&null!==n){if(o)return o;var a=Reflect.getOwnPropertyDescriptor(e,t);if(!a||!1!==a.writable||!1!==a.configurable)return R(n)}return o||n},has:function(e,t){var r=Reflect.has(e,t);return c({target:e,key:t,type:"has"}),r},ownKeys:function(e){return c({target:e,type:"iterate"}),Reflect.ownKeys(e)},set:function(e,t,r,n){"object"==typeof r&&null!==r&&(r=d.get(r)||r);var o=S.call(e,t),a=e[t],s=Reflect.set(e,t,r,n);return e!==d.get(n)||(o?r!==a&&i({target:e,key:t,value:r,oldValue:a,receiver:n,type:"set"}):i({target:e,key:t,value:r,receiver:n,type:"add"})),s},deleteProperty:function(e,t){var r=S.call(e,t),n=e[t],o=Reflect.deleteProperty(e,t);return r&&i({target:e,key:t,oldValue:n,type:"delete"}),o}};function R(e){return void 0===e&&(e={}),d.has(e)||"function"==typeof(r=e.constructor)&&r.name in k&&k[r.name]===r&&!w.has(r)?e:g.get(e)||function(e){var r=O(e)||M,n=new Proxy(e,r);return g.set(e,n),d.set(n,e),function(e){t.set(e,new Map)}(e),n}(e);var r}const P="js-element::ext::store";let E=!1,U=!1,A=null;function H(t,r){return E||(e.intercept("init",((e,t)=>{A=e;try{t()}finally{A=null}})),E=!0),(...e)=>{if(!A)throw new Error(`Hook function "${t}" has been invoked outside of component initialization phase`);return r(...e)}}function C(e){const t=A,r=t.getHost();let n=null;const o=new Promise((e=>{n=()=>e(null)}));let a=e.defaultValue;return t.beforeMount((()=>{const n={context:e,callback:e=>{a=e,t.refresh()},cancelled:o};r.dispatchEvent(new CustomEvent("$$context$$",{detail:n,bubbles:!0,composed:!0}))})),t.beforeUnmount((()=>n())),()=>a}const I=H("useCtx",(function(e){if(e&&"context"===e.kind)return C(e);const t={};return Object.entries(e).forEach((([r,n])=>{Object.defineProperty(t,r,{get:"context"===n.kind?C(n):e[r]})})),t}));const V=H("useHost",(()=>A.getHost())),$=H("useMethods",((e,t)=>{e&&t&&(e.current=t)})),B=H("useRefresher",(function(){return A.refresh})),z=H("useStatus",(function(){const e=A;return{isMounted:e.isMounted,hasUpdated:e.hasUpdated}})),T=H("useDefaults",(function(e,t){const r=A,n=Object.assign({},t,e);return r.beforeUpdate((()=>{for(const e in n)delete n[e];Object.assign(n,t,e)})),n})),W=H("useValue",(function(e){let t=e,r=e;const n=A;return[()=>r,e=>{t="function"==typeof e?e(t):e,n.onceBeforeUpdate((()=>{r=t})),n.refresh()}]})),D=H("useState",(function(e){let t,r=!1;const n=A,o={...e};return t={...o},[o,(e,a)=>{r=!0,"string"==typeof e?t[e]="function"==typeof a?a(t[e]):a:"function"==typeof e?Object.assign(t,e(t)):Object.assign(t,e),n.onceBeforeUpdate((()=>{r&&(Object.assign(o,t),r=!1)})),n.refresh()}]})),N=H("useReactive",(function(t){return U||(e.intercept("render",((e,t)=>{!function(e,t){void 0===t&&(t={});var r=e[y]?e:function t(){return u(t,e,this,arguments)};r.scheduler=t.scheduler,r.debugger=t.debugger,r[y]=!0,t.lazy||r()}(t)})),U=!0),r=t,d.has(r)?t:R(t);var r}));const F=H("useStyles",((...e)=>{const t=A,r=(...e)=>{!function(e,t){if(t instanceof HTMLStyleElement)e.appendChild(t);else{const r=t.join("\n\n/* =============== */\n\n"),n=document.createElement("style");n.appendChild(document.createTextNode(r)),e.appendChild(n)}}(t.getHost().shadowRoot.firstChild,e)};return r.apply(null,e),r})),L=H("useEmitter",(function(){const e=A.getHost();return(t,r)=>{e.dispatchEvent(t),r&&r(t)}})),K=H("useMemo",(function(e,t){let r,n;return{get value(){const o=t();return r&&oe(r,o)||(n=e.apply(null,o)),r=o,n}}})),_=H("useAfterMount",(function(e){let t;const r=A;r.afterMount((()=>{t=e()})),r.beforeUnmount((()=>{"function"==typeof t&&t(),t=null}))})),q=H("useBeforeUpdate",(function(e){let t;const r=A;r.beforeMount((()=>{t=e()})),r.afterUpdate((()=>{"function"==typeof t&&t()})),r.beforeUnmount((()=>{"function"==typeof t&&t(),t=null}))})),G=H("useAfterUpdate",(function(e){let t;const r=A;r.afterUpdate((()=>{"function"==typeof t&&t(),t=e()})),r.beforeUnmount((()=>{"function"==typeof t&&t(),t=null}))})),J=H("useBeforeUnmount",(function(e){A.beforeUnmount(e)})),Q=H("useEffect",(function(e,t){let r,n=null;const o=A,a=()=>{let o=void 0===t;if(!o){const e=t();o=null===n||null===e||!oe(n,e),n=e}o&&(r&&r(),r=e())};o.afterMount(a),o.afterUpdate(a),o.beforeUnmount((()=>r&&r()))})),X=H("useInterval",((e,t)=>{const r="function"==typeof t?t:()=>t;Q((()=>{const t=setInterval(e,r());return()=>clearInterval(t)}),(()=>[r()]))})),Y=H("useTimer",((e,t=Z)=>{let r=0;const n="function"==typeof e?e:()=>e,[o,a]=W(t(r++));return X((()=>{a(t(r++))}),(()=>n())),o}));function Z(){return new Date}const ee={result:void 0,error:void 0,state:"pending"},te=H("usePromise",(function(e,t){const[r,n]=D(ee);let o=-1;return Q((()=>{++o,"pending"!==r.state&&n(ee);const t=o;e().then((e=>{o===t&&n({result:e,state:"resolved"})})).catch((e=>{o===t&&n({error:e instanceof Error?e:new Error(String(e)),state:"rejected"})}))}),"function"==typeof t?t:()=>[]),{getState:()=>r.state,getResult:()=>r.result,getError:()=>r.error}})),re=H("useActions",(function(e){let t=null;const r=A,n={};r.beforeMount((()=>{if(ae(r,{type:P,payload:{setStore(e){t=e}}}),!t)throw new Error(`Store for actions not available (-> ${r.getName()})`)}));for(const r of Object.keys(e))n[r]=(...n)=>{t.dispatch(e[r](...n))};return n}));let ne=0;function oe(e,t){let r=Array.isArray(e)&&Array.isArray(t)&&e.length===t.length;if(r)for(let n=0;n<e.length;++n)if(e[n]!==t[n]){r=!1;break}return r}function ae(e,t){e.getHost().dispatchEvent(new CustomEvent("js-element/hooks::send+receive"+t.type,{bubbles:!0,composed:!0,detail:t}))}function se(e,t,r){const n=e.getHost(),o=e=>{e.stopPropagation(),r(e.detail)},a=()=>{n.removeEventListener("js-element/hooks::send+receive"+t,o)};return n.addEventListener("js-element/hooks::send+receive"+t,o),e.beforeUnmount(a),a}exports.createStoreHook=function(e){return()=>{const t={},r=B();for(const r of Object.keys(e.getState()))Object.defineProperty(t,r,{get:()=>e.getState()[r]});return _((()=>e.subscribe((()=>{r()})))),t}},exports.createStoreHooks=function(){const e=P+ ++ne;return[H("useStore",(t=>{const r=A;r.beforeMount((()=>{se(r,P,(e=>{e.payload.setStore(t)})),se(r,e,(e=>{e.payload.setStore(t)}))}))})),H("useSelectors",(function(t){let r=null;const n=A,o={};n.beforeMount((()=>{if(ae(n,{type:e,payload:{setStore(e){r=e}}}),!r)throw new Error(`Store for selectors not available (-> ${n.getName()})`);const t=r.subscribe((()=>{n.refresh()}));n.beforeUnmount(t)}));for(const e of Object.keys(t))Object.defineProperty(o,e,{get:()=>t[e](r.getState())});return o}))]},exports.hook=H,exports.useActions=re,exports.useAfterMount=_,exports.useAfterUpdate=G,exports.useBeforeMount=q,exports.useBeforeUnmount=J,exports.useCtx=I,exports.useDefaults=T,exports.useEffect=Q,exports.useEmitter=L,exports.useHost=V,exports.useInterval=X,exports.useMemo=K,exports.useMethods=$,exports.usePromise=te,exports.useReactive=N,exports.useRefresher=B,exports.useState=D,exports.useStatus=z,exports.useStyles=F,exports.useTimer=Y,exports.useValue=W;
